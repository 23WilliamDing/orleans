---
layout: page
title: Multi-Cluster Configuration
---

## 多群集配置

多群集配置确定哪些群集当前是多群集的一部分。它不会自动更改，但由操作员控制。因此，它与集群中使用的成员机制有很大不同，后者自动确定集群中的一组silos。

我们对服务中的集群使用以下术语：

-   集群是*积极的*如果它至少有一个活动silos，并且*不活动*否则
-   集群是*加入*如果它是当前多群集配置的一部分，并且*未连接*否则

活动/非活动与连接/非连接是独立的：所有四种组合都是可能的。

特定服务的所有集群都通过[八卦网](GossipChannels.md)是的。八卦网传播配置和状态信息。

### 注入配置

运营商通过将配置更改注入多集群网络来发布配置更改。配置可以注入到任何集群中，并从那里扩展到所有活动集群。每个新配置都包含一个组成多集群的集群id列表。它还有一个UTC时间戳，用于跟踪它在八卦网中的传播。

最初，多集群配置为空，这意味着多集群列表为空（不包含集群）。因此，操作员*必须*最初注入多群集配置。一旦注入，此配置将在所有连接的silos（运行时）和所有指定的八卦频道（如果这些频道是持久的）中持续存在。

我们对注入新配置提出了一些限制，操作员必须遵守这些限制：

-   每个新配置都可以添加多个集群，或删除多个集群（但不能同时删除这两个集群）。
-   在仍在处理以前的配置更改时，操作员不应发布新配置。

这些限制确保诸如单实例协议之类的协议可以正确地维护激活的互斥，即使在配置更改的情况下也是如此。

#### 经管粮

使用Orleans管理Grain，可以在任何集群中的任何节点上注入多集群配置。例如，要注入由三个集群{us1、eu1、us2}组成的多集群配置，我们可以向管理Grain传递一个可枚举的字符串：

```csharp
   var clusterlist = "us1,eu1,us2".Split(',');
   var mgtGrain = client.GetGrain<IManagementGrain>(0);	
   mgtGrain.InjectMultiClusterConfiguration(clusterlist, "my comment here"));
```

第一个论点`注入多群集配置`是群集ID的可枚举项，它将定义新的多群集配置。第二个参数是一个（可选）注释字符串，可用于用任意信息标记配置，例如谁注入了配置的原因。

有一个可选的第三个参数，一个名为`第一次检查`，默认为true。这意味着系统将尽最大努力检查是否有任何silos尚未赶上当前配置，如果发现此类silos，则拒绝更改。这有助于检测违反限制的情况，即一次只能挂起一个配置更改（尽管在任何情况下都不能保证）。

#### 通过默认配置

在预先知道多集群配置并且每次部署都是新的（例如为了测试）的情况下，我们可能希望提供默认配置。全局配置支持可选属性`默认多群集`它采用以逗号分隔的群集ID列表：

```csharp
var silo = new SiloHostBuilder()
  [...]
  .Configure<MultiClusterOptions>(options => 
  {
    [...]
    options.DefaultMultiCluster = new[] { "us1", "eu1", "us2" }; 
    [...]
  })
  [...]
```

使用此设置启动silos后，它将检查当前多群集配置是否为空，如果为空，则将给定配置注入当前UTC时间戳。

警告。持久的多集群八卦频道（例如，基于azuretable）保留上次注入的配置，除非它们被显式删除。在这种情况下，指定DefaultMultiCluster在重新部署群集时不起作用，因为存储在八卦频道中的配置不为空。>

#### 通过八卦频道

操作员还可以将配置直接注入八卦频道。频道中的变化会被周期性的背景八卦自动拾取和传播，尽管可能非常缓慢（使用管理Grain要快得多）。对传播时间的粗略估计是30秒（或全局配置中指定的任何八卦间隔）乘以所有集群中silos总数的二进制对数。但是，由于八卦对是随机选择的，所以它可以快得多，也可以慢得多。

如果使用基于azure表的八卦频道，运营商只需在`Orleans可行`，例如，使用某些工具编辑azure表中的数据。配置记录的格式如下：

| 姓名 | 类型 | 价值 |
| --- | --- | --- |
| 分区键 | 字符串 | 服务ID |
| 行键 | 字符串 | “配置” |
| 集群 | 字符串 | 群集ID的逗号分隔列表，例如“us1、eu1、us2” |
| 评论 | 字符串 | 可选注释 |
| 棉纱印花 | 日期时间 | 配置的UTC时间戳 |

<p/>

**注意**是啊。在存储器中编辑此记录时，gossipttimestamp也必须设置为比当前更新的值（否则将忽略更改）。最方便和推荐的方法是*删除gossipttimestamp字段*-然后，我们的gossip通道实现会自动将其替换为正确的当前时间戳（它使用azure表时间戳）。

### 群集添加/删除过程

从多集群中添加或删除集群通常需要在一些更大的上下文中进行协调。我们建议在从多群集添加/删除群集时始终遵循以下步骤。

#### 添加群集的过程

1.  启动一个新Orleans集群，等待所有silos都启动并运行。
2.  插入包含新群集的配置。
3.  开始将用户请求路由到新群集。

#### 删除群集的过程

1.  停止将新用户请求路由到群集。
2.  插入不再包含群集的配置。
3.  停止群集的所有silos。

以这种方式删除群集后，可以按照添加新群集的过程重新添加它。

### 非连接群集上的活动

在群集处于活动状态和未连接状态时，可能会有短暂的临时时间段：

-   新启动的集群可能在进入多集群配置之前（在添加集群的过程的步骤1和步骤2之间）开始执行代码。
-   正在停用的群集在关闭silos之前（在删除群集的过程的步骤2和步骤3之间）仍可以执行代码。

在这些中间情况下，可能出现以下情况：

-   对于全局单实例grains：grains可能在未连接的集群上具有重复激活。
-   对于已版本化的grains：当grains状态更改时，未连接群集上的激活不会收到通知。
